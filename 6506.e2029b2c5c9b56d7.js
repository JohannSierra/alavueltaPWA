"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6506],{6506:(V,f,g)=>{g.r(f),g.d(f,{AgregarPageModule:()=>y});var p=g(2881),u=g(4341),i=g(3092),h=g(5207),_=g(467),F=g(7643),m=g(5312),j=g(2186),e=g(1360),E=g(5032);const I=["inputImagen"];function k(r,c){if(1&r){const t=e.RV6();e.j41(0,"div",16)(1,"ion-card")(2,"ion-card-content",17)(3,"ion-button",18),e.bIt("click",function(){e.eBV(t);const o=e.XpG(2);return e.Njj(o.cerrarImagen())}),e.nrm(4,"ion-icon",19),e.k0s(),e.j41(5,"p"),e.EFF(6,"Ubica el c\xf3digo de barras en esta zona del empaque:"),e.k0s(),e.nrm(7,"img",20),e.k0s()()()}}function x(r,c){1&r&&(e.j41(0,"ion-text",21)(1,"p",17)(2,"strong"),e.EFF(3,"Producto no encontrado en la base p\xfablica"),e.k0s()()())}function A(r,c){if(1&r&&(e.j41(0,"div",22)(1,"p")(2,"strong"),e.EFF(3,"C\xf3digo:"),e.k0s(),e.EFF(4),e.k0s()()),2&r){const t=e.XpG(2);e.R7$(4),e.SpI(" ",t.codigoEscaneado,"")}}function P(r,c){if(1&r){const t=e.RV6();e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"Buscar por c\xf3digo de barras"),e.k0s(),e.j41(4,"ion-card-subtitle"),e.EFF(5,"Ingresa el c\xf3digo de barras para autocompletar"),e.k0s()(),e.j41(6,"ion-card-content")(7,"ion-item")(8,"ion-input",8),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.codigoEscaneado,o)||(a.codigoEscaneado=o),e.Njj(o)}),e.bIt("ionInput",function(o){e.eBV(t);const a=e.XpG();return e.Njj(a.validarCodigo(o))}),e.k0s(),e.j41(9,"ion-button",9),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.toggleMostrarImagen())}),e.nrm(10,"ion-icon",10),e.k0s()(),e.DNE(11,k,8,0,"div",11),e.j41(12,"ion-button",12),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.buscarProductoCodigo())}),e.EFF(13,"Buscar producto"),e.k0s(),e.j41(14,"p"),e.EFF(15,"O"),e.k0s(),e.j41(16,"ion-button",13),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.mostrarIngresoManual=!0)}),e.EFF(17," Ingresar manualmente "),e.k0s(),e.DNE(18,x,4,0,"ion-text",14)(19,A,5,1,"div",15),e.k0s()()}if(2&r){const t=e.XpG();e.R7$(8),e.R50("ngModel",t.codigoEscaneado),e.R7$(3),e.Y8G("ngIf",t.mostrarImagen),e.R7$(7),e.Y8G("ngIf",t.productoNoEncontrado),e.R7$(),e.Y8G("ngIf",t.codigoEscaneado)}}function M(r,c){if(1&r){const t=e.RV6();e.j41(0,"div",31),e.nrm(1,"img",32),e.j41(2,"ion-button",33),e.bIt("click",function(){e.eBV(t);const o=e.XpG(2);return e.Njj(o.eliminarImagen())}),e.nrm(3,"ion-icon",34),e.EFF(4," Quitar imagen "),e.k0s()()}if(2&r){const t=e.XpG(2);e.R7$(),e.Y8G("src",t.imagenURL,e.B4B)}}function G(r,c){if(1&r){const t=e.RV6();e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"Producto encontrado"),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-item")(6,"ion-label")(7,"strong"),e.EFF(8,"Nombre:"),e.k0s(),e.EFF(9),e.k0s()(),e.j41(10,"ion-item")(11,"ion-label",23),e.EFF(12,"Precio ($)"),e.k0s(),e.j41(13,"ion-input",24),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.precio,o)||(a.precio=o),e.Njj(o)}),e.k0s()(),e.j41(14,"ion-item")(15,"ion-label",23),e.EFF(16,"Cantidad"),e.k0s(),e.j41(17,"ion-input",24),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.cantidad,o)||(a.cantidad=o),e.Njj(o)}),e.k0s()(),e.j41(18,"ion-item")(19,"ion-label"),e.EFF(20,"Imagen del producto"),e.k0s(),e.j41(21,"ion-button",25),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.seleccionarImagen())}),e.nrm(22,"ion-icon",26),e.EFF(23," Seleccionar imagen "),e.k0s(),e.j41(24,"input",27,0),e.bIt("change",function(o){e.eBV(t);const a=e.XpG();return e.Njj(a.cargarImagen(o))}),e.k0s()(),e.DNE(26,M,5,1,"div",28),e.j41(27,"ion-button",29),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.agregar())}),e.EFF(28,"Agregar"),e.k0s(),e.j41(29,"ion-button",30),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.resetBusqueda())}),e.EFF(30," Nueva b\xfasqueda "),e.k0s()()()}if(2&r){const t=e.XpG();e.R7$(9),e.SpI(" ",t.nombre,""),e.R7$(4),e.R50("ngModel",t.precio),e.R7$(4),e.R50("ngModel",t.cantidad),e.R7$(9),e.Y8G("ngIf",t.imagenURL)}}function v(r,c){if(1&r){const t=e.RV6();e.j41(0,"div",31),e.nrm(1,"img",32),e.j41(2,"ion-button",33),e.bIt("click",function(){e.eBV(t);const o=e.XpG(2);return e.Njj(o.eliminarImagen())}),e.nrm(3,"ion-icon",34),e.EFF(4," Quitar imagen "),e.k0s()()}if(2&r){const t=e.XpG(2);e.R7$(),e.Y8G("src",t.imagenURL,e.B4B)}}function C(r,c){if(1&r){const t=e.RV6();e.j41(0,"ion-item",39),e.bIt("click",function(){const o=e.eBV(t).$implicit,a=e.XpG(3);return e.Njj(a.seleccionarCategoria(o))}),e.EFF(1),e.k0s()}if(2&r){const t=c.$implicit;e.R7$(),e.SpI(" ",t," ")}}function R(r,c){if(1&r&&(e.j41(0,"ion-list"),e.DNE(1,C,2,1,"ion-item",38),e.k0s()),2&r){const t=e.XpG(2);e.R7$(),e.Y8G("ngForOf",t.categoriasFiltradas)}}function N(r,c){if(1&r){const t=e.RV6();e.j41(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),e.EFF(3,"Agregar manualmente"),e.k0s()(),e.j41(4,"ion-card-content")(5,"ion-item")(6,"ion-label",23),e.EFF(7,"C\xf3digo de barras"),e.k0s(),e.j41(8,"ion-input",35),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.codigoEscaneado,o)||(a.codigoEscaneado=o),e.Njj(o)}),e.bIt("ionInput",function(o){e.eBV(t);const a=e.XpG();return e.Njj(a.validarCodigo(o))}),e.k0s()(),e.j41(9,"ion-item")(10,"ion-label",23),e.EFF(11,"Nombre del producto"),e.k0s(),e.j41(12,"ion-input",36),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.nombre,o)||(a.nombre=o),e.Njj(o)}),e.k0s()(),e.j41(13,"ion-item")(14,"ion-label",23),e.EFF(15,"Precio ($)"),e.k0s(),e.j41(16,"ion-input",24),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.precio,o)||(a.precio=o),e.Njj(o)}),e.k0s()(),e.j41(17,"ion-item")(18,"ion-label",23),e.EFF(19,"Cantidad"),e.k0s(),e.j41(20,"ion-input",24),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.cantidad,o)||(a.cantidad=o),e.Njj(o)}),e.k0s()(),e.j41(21,"ion-item")(22,"ion-label"),e.EFF(23,"Imagen del producto"),e.k0s(),e.j41(24,"ion-button",25),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.seleccionarImagen())}),e.nrm(25,"ion-icon",26),e.EFF(26," Seleccionar imagen "),e.k0s(),e.j41(27,"input",27,0),e.bIt("change",function(o){e.eBV(t);const a=e.XpG();return e.Njj(a.cargarImagen(o))}),e.k0s()(),e.DNE(29,v,5,1,"div",28),e.j41(30,"ion-item")(31,"ion-label",23),e.EFF(32,"Categor\xeda"),e.k0s(),e.j41(33,"ion-input",37),e.mxI("ngModelChange",function(o){e.eBV(t);const a=e.XpG();return e.DH7(a.categoria,o)||(a.categoria=o),e.Njj(o)}),e.bIt("ionInput",function(o){e.eBV(t);const a=e.XpG();return e.Njj(a.filtrarCategorias(o))}),e.k0s()(),e.DNE(34,R,2,1,"ion-list",4),e.j41(35,"ion-button",29),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.agregar())}),e.EFF(36,"Agregar"),e.k0s(),e.j41(37,"ion-button",30),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.mostrarIngresoManual=!1)}),e.EFF(38," Volver a b\xfasqueda autom\xe1tica "),e.k0s()()()}if(2&r){const t=e.XpG();e.R7$(8),e.R50("ngModel",t.codigoEscaneado),e.R7$(4),e.R50("ngModel",t.nombre),e.R7$(4),e.R50("ngModel",t.precio),e.R7$(4),e.R50("ngModel",t.cantidad),e.R7$(9),e.Y8G("ngIf",t.imagenURL),e.R7$(4),e.R50("ngModel",t.categoria),e.R7$(),e.Y8G("ngIf",t.categoriasFiltradas.length>0&&t.categoria)}}const B=[{path:"",component:(()=>{var r;class c{constructor(n,o,a){this.navCtrl=n,this.http=o,this.alertCtrl=a,this.codigoEscaneado="",this.nombre="",this.precio=0,this.cantidad=0,this.categoria="",this.mostrarIngresoManual=!1,this.productoEncontrado=!1,this.productoNoEncontrado=!1,this.mostrarImagen=!1,this.cargando=!1,this.categorias=["General","Frutas","Verduras","L\xe1cteos","Carnes","Bebidas","Snacks","Limpieza","Otros"],this.categoriasFiltradas=[],this.imagenURL=null,this.imagenFile=null}ngOnInit(){}toggleMostrarImagen(){this.mostrarImagen=!this.mostrarImagen}cerrarImagen(){this.mostrarImagen=!1}resetBusqueda(){this.codigoEscaneado="",this.nombre="",this.precio=0,this.cantidad=0,this.productoEncontrado=!1,this.productoNoEncontrado=!1,this.mostrarIngresoManual=!1,this.categoria="",this.categoriasFiltradas=[],this.imagenURL=null,this.imagenFile=null,this.inputImagen&&(this.inputImagen.nativeElement.value="")}filtrarCategorias(n){const o=n.target.value.toLowerCase();this.categoriasFiltradas=o?this.categorias.filter(a=>a.toLowerCase().includes(o)):[]}seleccionarCategoria(n){this.categoria=n,this.categoriasFiltradas=[]}seleccionarImagen(){var n;null===(n=this.inputImagen)||void 0===n||n.nativeElement.click()}cargarImagen(n){var o=this;return(0,_.A)(function*(){const a=n.target;if(a.files&&a.files.length>0){const s=a.files[0];if(s.size>5242880)return void o.mostrarAlerta("Imagen muy grande","La imagen no debe exceder 5MB");if(!s.type.match(/image\/(jpeg|png|jpg|webp)/))return void o.mostrarAlerta("Formato no soportado","Solo se aceptan im\xe1genes (JPEG, PNG, WEBP)");o.imagenFile=s;const d=new FileReader;d.onload=()=>{o.imagenURL=d.result},d.readAsDataURL(s)}})()}mostrarImagenCompleta(){this.imagenURL&&(this.mostrarImagen=!0)}eliminarImagen(){this.imagenFile=null,this.imagenURL=null,this.inputImagen&&(this.inputImagen.nativeElement.value="")}agregar(){var n=this;return(0,_.A)(function*(){const a=(0,j.getAuth)().currentUser;if(a)if(!n.codigoEscaneado||n.codigoEscaneado.length<8)n.mostrarAlerta("C\xf3digo inv\xe1lido","El c\xf3digo debe tener al menos 8 d\xedgitos");else if(!n.nombre||!n.precio||n.cantidad<=0)n.mostrarAlerta("Datos incompletos","Completa todos los campos obligatorios");else if(n.imagenFile&&n.imagenFile.size>5242880)n.mostrarAlerta("Error","La imagen no debe exceder 5MB");else{n.cargando=!0;try{const s=yield a.getIdToken(),d=new F.Lr({Authorization:`Bearer ${s}`}),l=new FormData;l.append("codigo",n.codigoEscaneado),l.append("nombre",n.nombre),l.append("precio",n.precio.toString()),l.append("cantidad",n.cantidad.toString()),l.append("categoria",n.categoria||"General"),l.append("descripcion",""),l.append("infoExtra",""),n.imagenFile&&l.append("imagen",n.imagenFile);try{yield n.http.post(`${m.c.apiUrl}/api/productos`,{codigo:n.codigoEscaneado,nombre:n.nombre,precioPromedio:n.precio,categoria:n.categoria||"General"},{headers:d}).toPromise()}catch(b){if(409!==b.status)throw b}yield n.http.post(`${m.c.apiUrl}/api/inventario`,l,{headers:d}).toPromise(),n.mostrarAlerta("\xc9xito","Producto agregado correctamente"),n.limpiarFormulario(),n.volver()}catch(s){console.error("Error al agregar producto:",s),n.mostrarAlerta("Error",n.obtenerMensajeError(s))}finally{n.cargando=!1}}else n.mostrarAlerta("Sesi\xf3n requerida","Debes iniciar sesi\xf3n para agregar productos")})()}obtenerMensajeError(n){var o;return 413===n.status?"La imagen es demasiado grande (m\xe1ximo 5MB)":415===n.status?"Formato de imagen no soportado (use JPEG, PNG o WEBP)":500===n.status?"Error en el servidor al procesar la imagen":(null===(o=n.error)||void 0===o?void 0:o.mensaje)||"Error al agregar el producto. Intente nuevamente."}buscarProductoCodigo(){!this.codigoEscaneado||this.codigoEscaneado.length<8||this.http.get(`${m.c.apiUrl}/api/productos/${this.codigoEscaneado}`).subscribe({next:n=>{this.nombre=n.nombre,this.precio=n.precioPromedio||n.precio||0,this.cantidad=0,this.categoria=n.categoria||"",this.productoEncontrado=!0,this.productoNoEncontrado=!1,n.imagenUrl&&(this.imagenURL=n.imagenUrl)},error:n=>{404===n.status?this.buscarEnOpenFoodFacts():(console.error("Error buscando producto:",n),this.productoEncontrado=!1,this.productoNoEncontrado=!0)}})}buscarEnOpenFoodFacts(){var n=this;return(0,_.A)(function*(){try{const a=yield(yield fetch(`https://world.openfoodfacts.org/api/v0/product/${n.codigoEscaneado}.json`)).json();if(1===a.status){const s=a.product;n.nombre=s.product_name||"",s.product_quantity&&s.product_quantity_unit&&(n.nombre+=` - ${s.product_quantity}${s.product_quantity_unit}`),s.categories&&(n.categoria=s.categories.split(",")[0]||""),n.productoEncontrado=!0}else n.productoEncontrado=!1}catch{n.productoEncontrado=!1}finally{n.productoNoEncontrado=!n.productoEncontrado}})()}validarCodigo(n){let o=n.target.value;o=o.replace(/\D/g,""),this.codigoEscaneado=o.slice(0,13)}limpiarFormulario(){this.codigoEscaneado="",this.nombre="",this.precio=0,this.cantidad=0,this.categoria="",this.productoEncontrado=!1,this.productoNoEncontrado=!1,this.categoriasFiltradas=[],this.imagenURL=null,this.imagenFile=null,this.inputImagen&&(this.inputImagen.nativeElement.value="")}volver(){this.navCtrl.navigateForward("/inventario")}mostrarAlerta(n,o){var a=this;return(0,_.A)(function*(){yield(yield a.alertCtrl.create({header:n,message:o,buttons:["OK"]})).present()})()}}return(r=c).\u0275fac=function(n){return new(n||r)(e.rXU(E.q9),e.rXU(F.Qq),e.rXU(i.hG))},r.\u0275cmp=e.VBU({type:r,selectors:[["app-agregar"]],viewQuery:function(n,o){if(1&n&&e.GBs(I,5),2&n){let a;e.mGM(a=e.lsd())&&(o.inputImagen=a.first)}},standalone:!1,decls:18,vars:5,consts:[["inputImagen",""],[3,"translucent"],["expand","block","color","medium","slot","start",3,"click"],[1,"ion-padding",3,"fullscreen"],[4,"ngIf"],[1,"ion-padding","ion-text-center"],[2,"font-size","0.85em","color","gray"],["href","https://world.openfoodfacts.org","target","_blank","rel","noopener noreferrer"],["placeholder","C\xf3digo de barras","type","text","inputmode","numeric","maxlength","13",3,"ngModelChange","ionInput","ngModel"],["fill","clear","slot","end","aria-label","Info c\xf3digo de barras",3,"click"],["name","information-circle-outline"],["class","ion-padding-top",4,"ngIf"],["expand","block","color","primary",3,"click"],["expand","block","color","medium",3,"click"],["color","danger",4,"ngIf"],["class","ion-text-center ion-margin-top",4,"ngIf"],[1,"ion-padding-top"],[1,"ion-text-center"],["fill","clear","size","small","color","medium",2,"position","absolute","top","5px","right","5px",3,"click"],["name","close-outline"],["src","assets/codigo_barras_ejemplo.png","alt","Ejemplo c\xf3digo barras",2,"max-width","100%","border-radius","8px"],["color","danger"],[1,"ion-text-center","ion-margin-top"],["position","floating"],["type","number",3,"ngModelChange","ngModel"],["fill","outline",3,"click"],["name","image-outline"],["type","file","hidden","","accept","image/*",3,"change"],["class","ion-text-center ion-padding-top",4,"ngIf"],["expand","block","color","success",3,"click"],["expand","block","color","medium",1,"ion-margin-top",3,"click"],[1,"ion-text-center","ion-padding-top"],["alt","Previsualizaci\xf3n imagen",2,"max-width","150px","border-radius","8px",3,"src"],["fill","clear","color","danger","size","small",3,"click"],["name","close-circle-outline"],["type","text","inputmode","numeric","maxlength","13",3,"ngModelChange","ionInput","ngModel"],[3,"ngModelChange","ngModel"],["placeholder","Escribe o selecciona categor\xeda","autocomplete","on","autocorrect","off","spellcheck","false",3,"ngModelChange","ionInput","ngModel"],["button","",3,"click",4,"ngFor","ngForOf"],["button","",3,"click"]],template:function(n,o){1&n&&(e.j41(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-button",2),e.bIt("click",function(){return o.volver()}),e.EFF(3," Atr\xe1s "),e.k0s(),e.j41(4,"ion-title"),e.EFF(5,"Agrega un producto a tu inventario"),e.k0s()()(),e.j41(6,"ion-content",3),e.DNE(7,P,20,4,"ion-card",4)(8,G,31,4,"ion-card",4)(9,N,39,7,"ion-card",4),e.k0s(),e.j41(10,"ion-footer",5)(11,"p"),e.EFF(12," Con tu c\xf3digo de barras puedes agregar productos y facilitar el autocompletado para otros usuarios. "),e.k0s(),e.j41(13,"p",6),e.EFF(14," Datos proporcionados por "),e.j41(15,"a",7),e.EFF(16," OpenFoodFacts "),e.k0s(),e.EFF(17,". "),e.k0s()()),2&n&&(e.Y8G("translucent",!0),e.R7$(6),e.Y8G("fullscreen",!0),e.R7$(),e.Y8G("ngIf",!o.mostrarIngresoManual&&!o.productoEncontrado),e.R7$(),e.Y8G("ngIf",o.productoEncontrado&&!o.mostrarIngresoManual),e.R7$(),e.Y8G("ngIf",o.mostrarIngresoManual))},dependencies:[p.Sq,p.bT,u.BC,u.tU,u.vS,i.Jm,i.b_,i.I9,i.ME,i.HW,i.tN,i.W9,i.M0,i.eU,i.iq,i.$w,i.uz,i.he,i.nf,i.IO,i.BC,i.ai,i.su,i.Gw],styles:[".botones-seleccion[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:10px}.botones-seleccion[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{flex:1}.p[_ngcontent-%COMP%]{text-align:center;align-items:center}.ion-padding[_ngcontent-%COMP%]{padding:10px}"]}),c})()}];let T=(()=>{var r;class c{}return(r=c).\u0275fac=function(n){return new(n||r)},r.\u0275mod=e.$C({type:r}),r.\u0275inj=e.G2t({imports:[h.iI.forChild(B),h.iI]}),c})(),y=(()=>{var r;class c{}return(r=c).\u0275fac=function(n){return new(n||r)},r.\u0275mod=e.$C({type:r}),r.\u0275inj=e.G2t({imports:[p.MD,u.YN,i.bv,T]}),c})()}}]);