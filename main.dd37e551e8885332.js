(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8792],{103:(y,I,n)=>{"use strict";var u=n(6479),d=n(2214),v=n(5312),a=n(1360),m=n(7664),E=n(5032),M=n(3092),O=n(4341),A=n(7643),j=n(467),D=n(2186),r=n(4796),l=n(2471),c=n(2881);function f(t,s){1&t&&(a.qex(0),a.j41(1,"div",2),a.EFF(2," Cargando sesi\xf3n... "),a.k0s(),a.bVm())}function P(t,s){1&t&&a.nrm(0,"router-outlet")}let C=(()=>{var t;class s{constructor(e,o,i,g){this.router=e,this.authService=o,this.swUpdate=i,this.toastCtrl=g,this.loading=!0}ngOnInit(){this.verificarSesion(),this.verificarActualizaciones(),this.agregarBotonDebug()}verificarSesion(){var e=this;const o=(0,D.getAuth)();(0,D.onAuthStateChanged)(o,function(){var i=(0,j.A)(function*(g){if(g)try{var h;const T=yield g.getIdToken();e.authService.setToken(T);const W=yield e.authService.fetchUserProfile(),H=null!==(h=null==W?void 0:W.vendedor)&&void 0!==h&&h;if(["/","/login","/home","/register"].includes(e.router.url)){const V=H?"/inventario":"/hub";e.router.url!==V&&e.router.navigateByUrl(V,{replaceUrl:!0})}}catch(T){console.error("Error al obtener perfil o token:",T),e.authService.clearToken(),e.router.navigateByUrl("/login",{replaceUrl:!0})}else e.authService.clearToken(),["/perfil","/inventario","/hub","/agregar","/carrito"].includes(e.router.url)&&e.router.navigateByUrl("/login",{replaceUrl:!0});e.loading=!1});return function(g){return i.apply(this,arguments)}}())}verificarActualizaciones(){var e=this;this.swUpdate.isEnabled?(console.log("Service Worker habilitado - Verificando actualizaciones..."),this.swUpdate.versionUpdates.subscribe(function(){var o=(0,j.A)(function*(i){console.log("Service Worker update event:",i.type),"VERSION_READY"===i.type&&(console.log("Nueva versi\xf3n detectada, forzando actualizaci\xf3n..."),yield(yield e.toastCtrl.create({message:"Nueva versi\xf3n disponible. Actualizando...",duration:2e3,color:"success",position:"top"})).present(),setTimeout(()=>{e.forceUpdate()},2e3)),"VERSION_DETECTED"===i.type&&console.log("Nueva versi\xf3n detectada, descargando..."),"NO_NEW_VERSION_DETECTED"===i.type&&console.log("No hay nuevas versiones disponibles")});return function(i){return o.apply(this,arguments)}}()),setTimeout(()=>{this.swUpdate.checkForUpdate().then(o=>{console.log("Check inicial de actualizaci\xf3n:",o?"UPDATE AVAILABLE":"NO UPDATE")})},1e3),setInterval(()=>{this.swUpdate.checkForUpdate().then(o=>{o&&console.log("Actualizaci\xf3n detectada en check peri\xf3dico")})},6e5)):console.log("Service Worker no est\xe1 habilitado")}forceUpdate(){var e=this;return(0,j.A)(function*(){if(e.swUpdate.isEnabled)try{console.log("Activando actualizaci\xf3n forzada..."),yield e.swUpdate.activateUpdate(),console.log("Actualizaci\xf3n activada, recargando..."),document.location.reload()}catch(o){console.error("Error forzando actualizaci\xf3n:",o),document.location.reload()}})()}clearSWCache(){var e=this;return(0,j.A)(function*(){if("caches"in window)try{const o=yield caches.keys();let i=0;for(const h of o)h.includes("ngsw")&&(yield caches.delete(h),i++,console.log(`Cache eliminado: ${h}`));yield(yield e.toastCtrl.create({message:`Cache limpiado (${i} elementos)`,duration:2e3,color:"warning"})).present(),setTimeout(()=>document.location.reload(),1e3)}catch(o){console.error("Error limpiando cache:",o)}})()}agregarBotonDebug(){window.location.hostname.includes("web.app")||setTimeout(()=>{const e=document.createElement("button");e.innerHTML="\u{1f504} Debug SW",e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.zIndex="9999",e.style.padding="10px",e.style.background="#ff4444",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.cursor="pointer",e.addEventListener("click",()=>{this.clearSWCache()}),document.body.appendChild(e)},3e3)}checkSWStatus(){"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{console.log("Service Workers registrados:",e.length),e.forEach(o=>{var i;console.log("SW scope:",o.scope),console.log("SW state:",null===(i=o.active)||void 0===i?void 0:i.state)})})}}return(t=s).\u0275fac=function(e){return new(e||t)(a.rXU(m.Ix),a.rXU(r.u),a.rXU(l.EI),a.rXU(M.K_))},t.\u0275cmp=a.VBU({type:t,selectors:[["app-root"]],standalone:!1,decls:3,vars:2,consts:[["appContent",""],[4,"ngIf","ngIfElse"],[1,"loading-screen"]],template:function(e,o){if(1&e&&a.DNE(0,f,3,0,"ng-container",1)(1,P,1,0,"ng-template",null,0,a.C5r),2&e){const i=a.sdS(2);a.Y8G("ngIf",o.loading)("ngIfElse",i)}},dependencies:[c.bT,m.n3],encapsulation:2}),s})();var S=n(5207),b=n(7673),R=n(9908),B=n(1397);let U=(()=>{var t;class s{constructor(e,o){this.router=e,this.authService=o}canActivate(){var e=this;return(0,j.A)(function*(){const o=e.authService.getToken();if(!o)return e.router.navigate(["/login"]),!1;const i=e.authService.decodeToken(o);if(!i)return e.router.navigate(["/login"]),!1;const g=Math.floor(Date.now()/1e3),h=i.exp;return!(!h||h<g)||!!(yield e.authService.refreshIdToken())||(yield e.authService.logout(),e.router.navigate(["/login"]),!1)})()}}return(t=s).\u0275fac=function(e){return new(e||t)(a.KVO(m.Ix),a.KVO(r.u))},t.\u0275prov=a.jDH({token:t,factory:t.\u0275fac,providedIn:"root"}),s})(),k=(()=>{var t;class s{constructor(e,o){this.authService=e,this.router=o}canActivate(e){var o=this;return(0,j.A)(function*(){if(!o.authService.isAuthenticated())return o.router.parseUrl("/login");const i=e.data.tipo,g=o.authService.esVendedor;let h=g;if(null===g)try{h=(yield o.authService.fetchUserProfile()).vendedor}catch(T){return console.error("Error verificando rol:",T),o.router.parseUrl("/login")}return!!("vendedor"===i&&h||"cliente"===i&&!h)||o.router.parseUrl(h?"/inventario":"/hub")})()}}return(t=s).\u0275fac=function(e){return new(e||t)(a.KVO(r.u),a.KVO(m.Ix))},t.\u0275prov=a.jDH({token:t,factory:t.\u0275fac,providedIn:"root"}),s})();class x{preload(s,p){var e;const o=navigator.connection;return o&&(o.saveData||o.effectiveType&&o.effectiveType.includes("2g")||o.effectiveType&&o.effectiveType.includes("slow-2g"))?(0,b.of)(null):null!==(e=s.data)&&void 0!==e&&e.preload?(0,R.O)(s.data.delay||0).pipe((0,B.Z)(()=>p())):(0,b.of)(null)}}const L=[{path:"",loadChildren:()=>Promise.all([n.e(2076),n.e(6013)]).then(n.bind(n,6013)).then(t=>t.HubPageModule),canActivate:[U,k],data:{tipo:"cliente"}},{path:"home",loadChildren:()=>n.e(5075).then(n.bind(n,5075)).then(t=>t.HomePageModule),data:{preload:!0,delay:8e3}},{path:"login",loadChildren:()=>n.e(3485).then(n.bind(n,3485)).then(t=>t.LoginPageModule)},{path:"register",loadChildren:()=>Promise.all([n.e(2076),n.e(8618)]).then(n.bind(n,8618)).then(t=>t.RegisterPageModule)},{path:"producto/:id",loadChildren:()=>n.e(5848).then(n.bind(n,5848)).then(t=>t.ProductoPageModule),canActivate:[U,k],data:{tipo:"cliente",preload:!0,delay:5e3}},{path:"inventario",loadChildren:()=>n.e(4337).then(n.bind(n,4337)).then(t=>t.InventarioPageModule),canActivate:[U,k],data:{tipo:"vendedor"}},{path:"agregar",loadChildren:()=>n.e(6506).then(n.bind(n,6506)).then(t=>t.AgregarPageModule),canActivate:[U,k],data:{tipo:"vendedor"}},{path:"perfil",loadChildren:()=>n.e(1849).then(n.bind(n,1849)).then(t=>t.PerfilPageModule),canActivate:[U],data:{preload:!0,delay:1e4}},{path:"historial",loadChildren:()=>n.e(1918).then(n.bind(n,1918)).then(t=>t.HistorialPageModule),canActivate:[U,k],data:{tipo:"cliente",preload:!0,delay:12e3}},{path:"**",redirectTo:""}];let z=(()=>{var t;class s{}return(t=s).\u0275fac=function(e){return new(e||t)},t.\u0275mod=a.$C({type:t}),t.\u0275inj=a.G2t({providers:[x],imports:[S.iI.forRoot(L,{preloadingStrategy:x,initialNavigation:"enabledNonBlocking",scrollPositionRestoration:"disabled",anchorScrolling:"disabled",enableTracing:!1}),S.iI]}),s})();var G=n(6648),N=n(5558);let K=(()=>{var t;class s{constructor(e){this.authService=e}intercept(e,o){return(0,G.H)(this.authService.getIdToken()).pipe((0,N.n)(i=>{if(i){const g=e.clone({setHeaders:{Authorization:`Bearer ${i}`}});return o.handle(g)}return o.handle(e)}))}}return(t=s).\u0275fac=function(e){return new(e||t)(a.KVO(r.u))},t.\u0275prov=a.jDH({token:t,factory:t.\u0275fac}),s})();(0,d.Wp)(v.c.firebaseConfig);let F=(()=>{var t;class s{}return(t=s).\u0275fac=function(e){return new(e||t)},t.\u0275mod=a.$C({type:t,bootstrap:[C]}),t.\u0275inj=a.G2t({providers:[{provide:m.b,useClass:E.jM},{provide:A.a7,useClass:K,multi:!0}],imports:[u.Bb,M.bv.forRoot({mode:"md",rippleEffect:!0,animated:!0}),z,O.YN,A.q1,l.WJ.register("ngsw-worker.js",{enabled:!(0,a.naY)(),registrationStrategy:"registerWhenStable:30000"})]}),s})();(0,d.Wp)(v.c.firebaseConfig),u.sG().bootstrapModule(F).catch(t=>console.error(t)),"serviceWorker"in navigator&&v.c.production&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/ngsw-worker.js").then(t=>console.log("\u2705 Service Worker registrado:",t)).catch(t=>console.warn("\u274c Error al registrar SW:",t))})},4796:(y,I,n)=>{"use strict";n.d(I,{u:()=>O});var u=n(467),d=n(2186),v=n(7643),a=n(5312),m=n(8866),E=n(1360),M=n(7664);let O=(()=>{var A;class j{constructor(r,l){var c=this;this.router=r,this.http=l,this.auth=(0,d.getAuth)(),this.currentUser=null,this.token=null,this.esVendedor=null,(0,d.setPersistence)(this.auth,d.browserLocalPersistence).then(()=>{}).catch(P=>{console.error("Error estableciendo persistencia local:",P)}),(0,d.onAuthStateChanged)(this.auth,function(){var P=(0,u.A)(function*(C){if(c.currentUser=C,C)try{const S=yield(0,d.getIdToken)(C);c.token=S,localStorage.setItem("token",S)}catch(S){console.error("Error obteniendo token en onAuthStateChanged:",S)}else c.token=null,c.esVendedor=null,localStorage.removeItem("token")});return function(C){return P.apply(this,arguments)}}());const f=localStorage.getItem("token");f&&(this.token=f)}registerUser(r){const l=this.getToken();if(!l)return Promise.reject("No token disponible");const c=new v.Lr({Authorization:`Bearer ${l}`,"Content-Type":"application/json"});return this.http.post(`${a.c.apiUrl}/api/usuarios`,r,{headers:c}).toPromise()}login(r,l){var c=this;return(0,u.A)(function*(){try{yield(0,d.setPersistence)(c.auth,d.browserLocalPersistence);const f=yield(0,d.signInWithEmailAndPassword)(c.auth,r,l);return c.currentUser=f.user,c.token=yield(0,d.getIdToken)(f.user),localStorage.setItem("token",c.token||""),f}catch(f){throw console.error("Error durante login:",f),f}})()}logout(){return(0,d.signOut)(this.auth).then(()=>{this.currentUser=null,this.token=null,this.esVendedor=null,localStorage.removeItem("token"),this.router.navigate(["/login"])})}getUser(){return this.currentUser}isAuthenticated(){return null!==this.currentUser||null!==this.token}getIdToken(){var r=this;return(0,u.A)(function*(){if(r.currentUser)try{return yield(0,d.getIdToken)(r.currentUser)}catch(l){return console.error("Error obteniendo token:",l),null}return null})()}refreshIdToken(){var r=this;return(0,u.A)(function*(){if(r.currentUser)try{const l=yield(0,d.getIdToken)(r.currentUser,!0);return r.token=l,localStorage.setItem("token",l),l}catch(l){return console.error("Error renovando token:",l),null}return null})()}getToken(){return this.token||localStorage.getItem("token")}decodeToken(r){try{return r||(r=this.getToken()||void 0),r?(0,m.s)(r):null}catch(l){return console.error("Error decodificando token:",l),null}}setToken(r){this.token=r,r?localStorage.setItem("token",r):localStorage.removeItem("token")}clearToken(){this.token=null,this.esVendedor=null,localStorage.removeItem("token")}fetchAccessToken(){return this.getIdToken().then(r=>(r?(console.log("Token de acceso:",r),this.token=r,localStorage.setItem("token",r)):console.warn("No se pudo obtener token: usuario no autenticado"),r)).catch(r=>(console.error("Error obteniendo token:",r),null))}fetchUserProfile(){const r=this.getToken();if(!r)return Promise.reject("No token disponible");const l=new v.Lr({Authorization:`Bearer ${r}`});return this.http.get(`${a.c.apiUrl}/api/usuarios/me`,{headers:l}).toPromise().then(c=>(this.esVendedor=c.vendedor,c)).catch(c=>{throw console.error("Error obteniendo perfil de usuario:",c),this.esVendedor=null,c})}getCorreo(){var r;return(null===(r=this.currentUser)||void 0===r?void 0:r.email)||null}}return(A=j).\u0275fac=function(r){return new(r||A)(E.KVO(M.Ix),E.KVO(v.Qq))},A.\u0275prov=E.jDH({token:A,factory:A.\u0275fac,providedIn:"root"}),j})()},5312:(y,I,n)=>{"use strict";n.d(I,{c:()=>u});const u={production:!0,apiUrl:"https://backendalv.onrender.com",firebaseConfig:{apiKey:"AIzaSyCw_58mvh1mqA_JwlcgVXRHf7Dv75eZJMU",authDomain:"alavuelta-1c6c1.firebaseapp.com",projectId:"alavuelta-1c6c1",storageBucket:"alavuelta-1c6c1.appspot.com",messagingSenderId:"33525710896",appId:"1:33525710896:web:32e062713ff3a57d09edf5",measurementId:"G-GMC7JTPCVG"}}},8996:(y,I,n)=>{var u={"./ion-accordion_2.entry.js":[2375,2076,2375],"./ion-action-sheet.entry.js":[8814,2076,8814],"./ion-alert.entry.js":[5222,2076,5222],"./ion-app_8.entry.js":[7720,2076,7720],"./ion-avatar_3.entry.js":[1049,1049],"./ion-back-button.entry.js":[3162,2076,3162],"./ion-backdrop.entry.js":[7240,7240],"./ion-breadcrumb_2.entry.js":[8314,2076,8314],"./ion-button_2.entry.js":[4591,4591],"./ion-card_5.entry.js":[8584,8584],"./ion-checkbox.entry.js":[3511,3511],"./ion-chip.entry.js":[6024,6024],"./ion-col_3.entry.js":[5100,5100],"./ion-datetime-button.entry.js":[7428,4704,7428],"./ion-datetime_3.entry.js":[2885,4704,2076,2885],"./ion-fab_3.entry.js":[4463,2076,4463],"./ion-img.entry.js":[4183,4183],"./ion-infinite-scroll_2.entry.js":[4171,2076,4171],"./ion-input-password-toggle.entry.js":[6521,2076,6521],"./ion-input.entry.js":[9344,2076,9344],"./ion-item-option_3.entry.js":[5949,2076,5949],"./ion-item_8.entry.js":[3506,2076,3506],"./ion-loading.entry.js":[7372,2076,7372],"./ion-menu_3.entry.js":[2075,2076,2075],"./ion-modal.entry.js":[441,2076,441],"./ion-nav_2.entry.js":[5712,2076,5712],"./ion-picker-column-option.entry.js":[9013,9013],"./ion-picker-column.entry.js":[1459,2076,1459],"./ion-picker.entry.js":[6840,6840],"./ion-popover.entry.js":[6433,2076,6433],"./ion-progress-bar.entry.js":[9977,9977],"./ion-radio_2.entry.js":[8066,2076,8066],"./ion-range.entry.js":[8477,2076,8477],"./ion-refresher_2.entry.js":[5197,2076,5197],"./ion-reorder_2.entry.js":[7030,2076,7030],"./ion-ripple-effect.entry.js":[964,964],"./ion-route_4.entry.js":[8970,8970],"./ion-searchbar.entry.js":[8193,2076,8193],"./ion-segment-content.entry.js":[9073,9073],"./ion-segment-view.entry.js":[323,323],"./ion-segment_2.entry.js":[2560,2076,2560],"./ion-select-modal.entry.js":[770,770],"./ion-select_3.entry.js":[7076,2076,7076],"./ion-spinner.entry.js":[8805,2076,8805],"./ion-split-pane.entry.js":[5887,5887],"./ion-tab-bar_2.entry.js":[4406,2076,4406],"./ion-tab_2.entry.js":[1102,1102],"./ion-text.entry.js":[1577,1577],"./ion-textarea.entry.js":[2348,2076,2348],"./ion-toast.entry.js":[2415,2076,2415],"./ion-toggle.entry.js":[3814,2076,3814]};function d(v){if(!n.o(u,v))return Promise.resolve().then(()=>{var E=new Error("Cannot find module '"+v+"'");throw E.code="MODULE_NOT_FOUND",E});var a=u[v],m=a[0];return Promise.all(a.slice(1).map(n.e)).then(()=>n(m))}d.keys=()=>Object.keys(u),d.id=8996,y.exports=d}},y=>{y.O(0,[4121],()=>y(y.s=103)),y.O()}]);